<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Food Tracker - –°–∫–∞–Ω–µ—Ä</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #000000);
      color: var(--tg-theme-text-color, #ffffff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      text-align: center;
      max-width: 320px;
      width: 100%;
    }

    .icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999);
      margin-bottom: 32px;
      line-height: 1.4;
    }

    .btn {
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    .btn:disabled {
      opacity: 0.5;
      transform: none;
    }

    .btn-secondary {
      background: var(--tg-theme-secondary-bg-color, #2c2c2e);
    }

    .btn-icon {
      font-size: 20px;
    }

    .result {
      margin-top: 24px;
      padding: 16px;
      background: var(--tg-theme-secondary-bg-color, #1c1c1e);
      border-radius: 12px;
      display: none;
    }

    .result.show {
      display: block;
    }

    .result.success {
      background: #34c759;
    }

    .result.error {
      background: #ff3b30;
    }

    .result-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .result-text {
      font-size: 14px;
      word-break: break-all;
    }

    .formats {
      margin-top: 32px;
      font-size: 11px;
      color: var(--tg-theme-hint-color, #666);
    }

    .platform-info {
      margin-top: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 12px;
      color: var(--tg-theme-hint-color, #888);
    }

    .loading {
      display: none;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--tg-theme-button-color, #3390ec);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Hidden file input */
    #file-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">üì∑</div>
    <h1>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</h1>
    <p class="subtitle">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–∞ —É–ø–∞–∫–æ–≤–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞</p>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–û—Ç–∫—Ä—ã–≤–∞—é –∫–∞–º–µ—Ä—É...</p>
    </div>

    <div id="buttons">
      <button id="scan-btn" class="btn">
        <span class="btn-icon">üì∏</span>
        <span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π</span>
      </button>

      <button id="photo-btn" class="btn btn-secondary">
        <span class="btn-icon">üñºÔ∏è</span>
        <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
      </button>
    </div>

    <input type="file" id="file-input" accept="image/*" capture="environment">

    <div id="result" class="result">
      <div id="result-icon" class="result-icon"></div>
      <div id="result-text" class="result-text"></div>
    </div>

    <div class="formats">
      –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: EAN-13 ‚Ä¢ EAN-8 ‚Ä¢ UPC-A ‚Ä¢ UPC-E
    </div>

    <div id="platform-info" class="platform-info"></div>
  </div>

  <!-- html5-qrcode for Android only -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const scanBtn = document.getElementById('scan-btn');
    const photoBtn = document.getElementById('photo-btn');
    const fileInput = document.getElementById('file-input');
    const resultDiv = document.getElementById('result');
    const resultIcon = document.getElementById('result-icon');
    const resultText = document.getElementById('result-text');
    const loading = document.getElementById('loading');
    const buttons = document.getElementById('buttons');
    const platformInfo = document.getElementById('platform-info');

    // Detect platform
    const platform = tg.platform || 'unknown';
    const isIOS = platform === 'ios' || /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = platform === 'android' || /Android/i.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;

    platformInfo.textContent = `–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${platform} | ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}`;

    function showLoading(text) {
      loading.querySelector('p').textContent = text || '–ó–∞–≥—Ä—É–∑–∫–∞...';
      loading.classList.add('show');
      buttons.style.display = 'none';
    }

    function hideLoading() {
      loading.classList.remove('show');
      buttons.style.display = 'block';
    }

    function showResult(icon, text, isSuccess) {
      resultIcon.textContent = icon;
      resultText.textContent = text;
      resultDiv.className = 'result show ' + (isSuccess ? 'success' : 'error');
    }

    function sendBarcode(barcode) {
      showResult('üì§', '–û—Ç–ø—Ä–∞–≤–ª—è—é: ' + barcode, true);

      try {
        tg.HapticFeedback.notificationOccurred('success');
      } catch (e) {}

      setTimeout(() => {
        tg.sendData(JSON.stringify({
          type: 'barcode',
          code: barcode
        }));
        tg.close();
      }, 500);
    }

    function validateBarcode(code) {
      // Product barcodes: 8-14 digits
      return code && /^\d{8,14}$/.test(code);
    }

    // Main scan button - use Telegram native scanner (works on iOS!)
    scanBtn.addEventListener('click', function() {
      showLoading('–û—Ç–∫—Ä—ã–≤–∞—é –∫–∞–º–µ—Ä—É...');

      try {
        // Telegram's native scanner - works on both iOS and Android
        tg.showScanQrPopup({
          text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞'
        });
      } catch (e) {
        hideLoading();
        showResult('‚ùå', '–û—à–∏–±–∫–∞: ' + e.message, false);
      }
    });

    // Handle Telegram native scanner result
    tg.onEvent('qrTextReceived', function(data) {
      const code = data.data;
      console.log('Scanned:', code);

      try {
        tg.closeScanQrPopup();
      } catch (e) {}

      hideLoading();

      if (validateBarcode(code)) {
        sendBarcode(code);
      } else if (code && code.length > 0) {
        // Send anyway, let backend handle
        sendBarcode(code);
      } else {
        showResult('‚ö†Ô∏è', '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥', false);
      }
    });

    tg.onEvent('scanQrPopupClosed', function() {
      hideLoading();
    });

    // Photo upload button
    photoBtn.addEventListener('click', function() {
      fileInput.click();
    });

    // Handle file selection
    fileInput.addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;

      showLoading('–†–∞—Å–ø–æ–∑–Ω–∞—é —à—Ç—Ä–∏—Ö-–∫–æ–¥...');

      try {
        // Use html5-qrcode to scan from image
        const html5QrCode = new Html5Qrcode("result", {
          formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODE_128
          ]
        });

        const result = await html5QrCode.scanFile(file, true);
        console.log('File scan result:', result);

        hideLoading();

        if (validateBarcode(result)) {
          sendBarcode(result);
        } else if (result && result.length > 0) {
          sendBarcode(result);
        } else {
          showResult('‚ö†Ô∏è', '–®—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Ñ–æ—Ç–æ', false);
        }

      } catch (err) {
        console.error('Scan error:', err);
        hideLoading();
        showResult('‚ö†Ô∏è', '–®—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.', false);
      }

      // Reset input
      fileInput.value = '';
    });

    // Desktop fallback - show message
    if (!isMobile) {
      scanBtn.innerHTML = '<span class="btn-icon">üì∏</span><span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å (—Ç–æ–ª—å–∫–æ –º–æ–±–∏–ª—å–Ω—ã–π)</span>';
      scanBtn.addEventListener('click', function(e) {
        e.preventDefault();
        tg.showAlert('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ.');
      }, true);
    }
  </script>
</body>
</html>
