<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Food Tracker - –°–∫–∞–Ω–µ—Ä</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #000000);
      color: var(--tg-theme-text-color, #ffffff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 12px 16px;
      text-align: center;
      background: rgba(0,0,0,0.8);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header .hint {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
    }

    #scanner-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 60px;
      padding-bottom: 120px;
    }

    #reader {
      width: 100%;
      max-width: 500px;
    }

    #reader video {
      border-radius: 12px;
    }

    /* Override html5-qrcode styles */
    #reader__scan_region {
      background: transparent !important;
    }

    #reader__dashboard {
      display: none !important;
    }

    .scan-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 280px;
      height: 150px;
      border: 3px solid var(--tg-theme-button-color, #3390ec);
      border-radius: 16px;
      pointer-events: none;
      z-index: 50;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
    }

    .scan-line {
      position: absolute;
      top: 50%;
      left: 10px;
      right: 10px;
      height: 2px;
      background: linear-gradient(90deg, transparent, #ff0000, transparent);
      animation: scan 1.5s ease-in-out infinite;
    }

    @keyframes scan {
      0%, 100% { top: 20%; opacity: 0.5; }
      50% { top: 80%; opacity: 1; }
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: rgba(0,0,0,0.9);
      text-align: center;
    }

    .result {
      padding: 12px 16px;
      background: var(--tg-theme-secondary-bg-color, #1c1c1e);
      border-radius: 12px;
      margin-bottom: 12px;
      display: none;
    }

    .result.show {
      display: block;
    }

    .result.success {
      background: #34c759;
      color: white;
    }

    .result.error {
      background: #ff3b30;
      color: white;
    }

    .result-text {
      font-size: 14px;
      font-weight: 500;
    }

    .formats-hint {
      font-size: 11px;
      color: var(--tg-theme-hint-color, #666);
      margin-top: 8px;
    }

    .btn {
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: opacity 0.2s;
    }

    .btn:active {
      opacity: 0.8;
    }

    .btn:disabled {
      opacity: 0.5;
    }

    .btn-secondary {
      background: var(--tg-theme-secondary-bg-color, #2c2c2e);
      margin-top: 8px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--tg-theme-button-color, #3390ec);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</h1>
    <div class="hint">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥</div>
  </div>

  <div class="scan-overlay">
    <div class="scan-line"></div>
  </div>

  <div id="scanner-container">
    <div id="reader"></div>
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>
    </div>
  </div>

  <div class="footer">
    <div id="result" class="result">
      <div id="result-text" class="result-text"></div>
    </div>
    <button id="send-btn" class="btn" style="display: none;">
      –û—Ç–ø—Ä–∞–≤–∏—Ç—å
    </button>
    <div class="formats-hint">
      EAN-13 ‚Ä¢ EAN-8 ‚Ä¢ UPC-A ‚Ä¢ UPC-E ‚Ä¢ Code-128
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    const resultDiv = document.getElementById('result');
    const resultText = document.getElementById('result-text');
    const sendBtn = document.getElementById('send-btn');
    const loading = document.getElementById('loading');

    let html5QrCode = null;
    let lastScannedCode = null;
    let scanCooldown = false;

    // Supported barcode formats for products
    const formatsToSupport = [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.CODE_39
    ];

    function showResult(text, isSuccess) {
      resultText.textContent = text;
      resultDiv.className = 'result show ' + (isSuccess ? 'success' : 'error');
    }

    function hideResult() {
      resultDiv.className = 'result';
    }

    async function startScanner() {
      loading.classList.add('show');

      try {
        html5QrCode = new Html5Qrcode("reader", {
          formatsToSupport: formatsToSupport,
          verbose: false
        });

        const config = {
          fps: 15,  // Higher FPS for faster scanning
          qrbox: { width: 280, height: 150 },
          aspectRatio: 1.777,  // 16:9
          disableFlip: false,
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: true  // Use native BarcodeDetector if available
          }
        };

        await html5QrCode.start(
          { facingMode: "environment" },  // Back camera
          config,
          onScanSuccess,
          onScanFailure
        );

        loading.classList.remove('show');

      } catch (err) {
        loading.classList.remove('show');
        console.error("Camera error:", err);
        showResult("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err.message, false);

        // Fallback to Telegram native scanner
        setTimeout(() => {
          try {
            tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥' });
          } catch (e) {
            tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞.");
            tg.close();
          }
        }, 1500);
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      // Prevent duplicate scans
      if (scanCooldown || decodedText === lastScannedCode) {
        return;
      }

      scanCooldown = true;
      lastScannedCode = decodedText;

      // Haptic feedback
      try {
        tg.HapticFeedback.notificationOccurred('success');
      } catch (e) {}

      console.log("Scanned:", decodedText, decodedResult);

      // Validate barcode (8-14 digits for product barcodes)
      const isValid = /^\d{8,14}$/.test(decodedText);

      if (isValid) {
        showResult("‚úÖ " + decodedText, true);
        sendBarcode(decodedText);
      } else {
        showResult("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: " + decodedText, false);
        setTimeout(() => {
          scanCooldown = false;
          lastScannedCode = null;
          hideResult();
        }, 2000);
      }
    }

    function onScanFailure(error) {
      // Ignore scan failures (no barcode in frame)
    }

    function sendBarcode(barcode) {
      // Stop scanner
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }

      showResult("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é: " + barcode, true);

      setTimeout(() => {
        tg.sendData(JSON.stringify({
          type: 'barcode',
          code: barcode
        }));
        tg.close();
      }, 500);
    }

    // Handle Telegram native scanner result (fallback)
    tg.onEvent('qrTextReceived', function(data) {
      if (data.data) {
        onScanSuccess(data.data, { format: 'TELEGRAM_NATIVE' });
      }
    });

    tg.onEvent('scanQrPopupClosed', function() {
      // User closed native scanner
    });

    // Start scanner on load
    startScanner();
  </script>
</body>
</html>
